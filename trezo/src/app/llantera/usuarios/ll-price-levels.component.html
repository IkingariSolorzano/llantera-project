<div class="p-6">
  <!-- Header -->
  <div class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Niveles de Precio</h1>
      <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Administra los niveles de precio para tus clientes</p>
    </div>
    <button
      type="button"
      (click)="openCreateModal()"
      class="px-4 py-2.5 bg-[#E60012] hover:bg-[#c5000f] text-white font-medium rounded-lg flex items-center gap-2 transition-colors"
    >
      <i class="material-symbols-outlined !text-[18px]">add</i>
      Nuevo nivel
    </button>
  </div>

  <!-- Error -->
  @if (error()) {
    <div class="mb-4 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg text-red-600 dark:text-red-400 text-sm">
      {{ error() }}
    </div>
  }

  <!-- Loading -->
  @if (loading()) {
    <div class="flex items-center justify-center py-12">
      <div class="w-8 h-8 border-4 border-[#E60012] border-t-transparent rounded-full animate-spin"></div>
    </div>
  }

  <!-- List -->
  @if (!loading()) {
    <div class="bg-white dark:bg-[#0c1427] rounded-xl border border-gray-200 dark:border-[#172036] overflow-hidden">
      <table class="w-full">
        <thead class="bg-gray-50 dark:bg-[#0a0f1a]">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">Código</th>
            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">Nombre</th>
            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">Columna de Precio</th>
            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">Descuento</th>
            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">Ofertas</th>
            <th class="px-4 py-3 text-right text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">Acciones</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100 dark:divide-[#172036]">
          @for (level of levels(); track level.id) {
            <tr class="hover:bg-gray-50 dark:hover:bg-[#0a0f1a] transition-colors">
              <td class="px-4 py-3">
                <span class="px-2 py-1 bg-gray-100 dark:bg-[#15203c] text-gray-700 dark:text-gray-300 text-xs font-mono rounded">
                  {{ level.code }}
                </span>
              </td>
              <td class="px-4 py-3">
                <p class="text-sm font-medium text-gray-900 dark:text-white">{{ level.name }}</p>
                @if (level.description) {
                  <p class="text-xs text-gray-500 mt-0.5">{{ level.description }}</p>
                }
              </td>
              <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">
                {{ getColumnName(level.priceColumn) }}
              </td>
              <td class="px-4 py-3">
                @if (level.discountPercentage > 0) {
                  <span class="px-2 py-1 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 text-xs font-medium rounded">
                    -{{ level.discountPercentage }}%
                  </span>
                } @else {
                  <span class="text-xs text-gray-400">Sin descuento</span>
                }
              </td>
              <td class="px-4 py-3">
                @if (level.canViewOffers) {
                  <span class="flex items-center gap-1 text-xs text-green-600 dark:text-green-400">
                    <i class="material-symbols-outlined !text-[14px]">check_circle</i>
                    Sí
                  </span>
                } @else {
                  <span class="flex items-center gap-1 text-xs text-gray-400">
                    <i class="material-symbols-outlined !text-[14px]">cancel</i>
                    No
                  </span>
                }
              </td>
              <td class="px-4 py-3 text-right">
                <div class="flex items-center justify-end gap-1">
                  <button
                    type="button"
                    (click)="openEditModal(level)"
                    class="p-2 hover:bg-gray-100 dark:hover:bg-[#15203c] rounded-lg text-gray-500 hover:text-blue-600 transition-colors"
                    title="Editar"
                  >
                    <i class="material-symbols-outlined !text-[18px]">edit</i>
                  </button>
                  <button
                    type="button"
                    (click)="deleteLevel(level)"
                    class="p-2 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg text-gray-500 hover:text-red-600 transition-colors"
                    title="Eliminar"
                  >
                    <i class="material-symbols-outlined !text-[18px]">delete</i>
                  </button>
                </div>
              </td>
            </tr>
          } @empty {
            <tr>
              <td colspan="6" class="px-4 py-12 text-center">
                <i class="material-symbols-outlined !text-[48px] text-gray-300 dark:text-gray-600 mb-2">layers</i>
                <p class="text-gray-500 dark:text-gray-400">No hay niveles de precio configurados</p>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }
</div>

<!-- Modal -->
@if (showModal()) {
  <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
    <div class="bg-white dark:bg-[#0c1427] rounded-2xl p-6 max-w-lg w-full mx-4 shadow-2xl">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-lg font-bold text-gray-900 dark:text-white">
          {{ editingLevel() ? 'Editar nivel de precio' : 'Nuevo nivel de precio' }}
        </h2>
        <button type="button" (click)="closeModal()" class="p-2 hover:bg-gray-100 dark:hover:bg-[#15203c] rounded-lg transition-colors">
          <i class="material-symbols-outlined text-gray-500">close</i>
        </button>
      </div>

      <div class="space-y-4">
        <!-- Código -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Código</label>
          <input
            type="text"
            [ngModel]="formData().code"
            (ngModelChange)="updateField('code', $event)"
            class="w-full px-4 py-2.5 bg-gray-50 dark:bg-[#0a0f1a] border border-gray-200 dark:border-[#172036] rounded-lg text-gray-900 dark:text-white focus:ring-2 focus:ring-[#E60012] focus:border-transparent"
            placeholder="ej: mayoreo"
          />
        </div>

        <!-- Nombre -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nombre</label>
          <input
            type="text"
            [ngModel]="formData().name"
            (ngModelChange)="updateField('name', $event)"
            class="w-full px-4 py-2.5 bg-gray-50 dark:bg-[#0a0f1a] border border-gray-200 dark:border-[#172036] rounded-lg text-gray-900 dark:text-white focus:ring-2 focus:ring-[#E60012] focus:border-transparent"
            placeholder="ej: Precio Mayoreo"
          />
        </div>

        <!-- Columna de precio -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Columna de precio</label>
          <select
            [ngModel]="formData().priceColumn"
            (ngModelChange)="updateField('priceColumn', $event)"
            class="w-full px-4 py-2.5 bg-gray-50 dark:bg-[#0a0f1a] border border-gray-200 dark:border-[#172036] rounded-lg text-gray-900 dark:text-white focus:ring-2 focus:ring-[#E60012] focus:border-transparent"
          >
            @for (col of priceColumns(); track col.code) {
              <option [value]="col.code">{{ col.label }}</option>
            }
          </select>
        </div>

        <!-- Descuento -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Descuento adicional (%)</label>
          <input
            type="number"
            [ngModel]="formData().discountPercentage"
            (ngModelChange)="updateField('discountPercentage', $event)"
            class="w-full px-4 py-2.5 bg-gray-50 dark:bg-[#0a0f1a] border border-gray-200 dark:border-[#172036] rounded-lg text-gray-900 dark:text-white focus:ring-2 focus:ring-[#E60012] focus:border-transparent"
            min="0"
            max="100"
            step="0.01"
          />
        </div>

        <!-- Puede ver ofertas -->
        <div class="flex items-center gap-3">
          <input
            type="checkbox"
            id="canViewOffers"
            [ngModel]="formData().canViewOffers"
            (ngModelChange)="updateField('canViewOffers', $event)"
            class="w-5 h-5 rounded border-gray-300 text-[#E60012] focus:ring-[#E60012]"
          />
          <label for="canViewOffers" class="text-sm text-gray-700 dark:text-gray-300">
            Puede ver ofertas especiales
          </label>
        </div>

        <!-- Descripción -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Descripción (opcional)</label>
          <textarea
            [ngModel]="formData().description || ''"
            (ngModelChange)="updateField('description', $event || null)"
            class="w-full px-4 py-2.5 bg-gray-50 dark:bg-[#0a0f1a] border border-gray-200 dark:border-[#172036] rounded-lg text-gray-900 dark:text-white focus:ring-2 focus:ring-[#E60012] focus:border-transparent resize-none"
            rows="2"
            placeholder="Descripción del nivel de precio..."
          ></textarea>
        </div>
      </div>

      <div class="flex gap-3 mt-6">
        <button
          type="button"
          (click)="closeModal()"
          class="flex-1 py-2.5 bg-gray-200 dark:bg-[#172036] hover:bg-gray-300 dark:hover:bg-[#1e2a47] text-gray-900 dark:text-white font-medium rounded-lg transition-colors"
        >
          Cancelar
        </button>
        <button
          type="button"
          (click)="saveLevel()"
          [disabled]="loading()"
          class="flex-1 py-2.5 bg-[#E60012] hover:bg-[#c5000f] text-white font-medium rounded-lg transition-colors disabled:opacity-50"
        >
          @if (loading()) {
            <span class="flex items-center justify-center gap-2">
              <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
              Guardando...
            </span>
          } @else {
            {{ editingLevel() ? 'Actualizar' : 'Crear' }}
          }
        </button>
      </div>
    </div>
  </div>
}
