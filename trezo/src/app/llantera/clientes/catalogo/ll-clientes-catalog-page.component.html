<!-- Barra de búsqueda y filtros -->
<div class="mb-6">
  <!-- Búsqueda principal -->
  <div class="flex flex-col sm:flex-row gap-3 mb-4">
    <div class="flex-1 relative">
      <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
        <i class="material-symbols-outlined !text-[20px]">search</i>
      </span>
      <input
        type="text"
        [value]="searchQuery()"
        (input)="onSearchInput($event)"
        (keyup.enter)="onSearchSubmit()"
        placeholder="Buscar por medida, marca, modelo o SKU..."
        class="w-full h-11 pl-10 pr-4 rounded-xl border border-gray-200 dark:border-[#172036] bg-white dark:bg-[#0c1427] text-sm text-gray-900 dark:text-white placeholder:text-gray-400 focus:border-[#E60012] focus:ring-2 focus:ring-[#E60012]/20 outline-none transition-all"
      />
    </div>
    <button
      type="button"
      (click)="onSearchSubmit()"
      class="h-11 px-6 bg-[#E60012] hover:bg-red-700 text-white text-sm font-medium rounded-xl transition-colors flex items-center justify-center gap-2"
    >
      <i class="material-symbols-outlined !text-[18px]">search</i>
      Buscar
    </button>
    <button
      type="button"
      (click)="toggleFilters()"
      class="h-11 px-4 border border-gray-200 dark:border-[#172036] bg-white dark:bg-[#0c1427] text-gray-700 dark:text-gray-200 text-sm font-medium rounded-xl transition-colors flex items-center justify-center gap-2 hover:bg-gray-50 dark:hover:bg-[#15203c]"
    >
      <i class="material-symbols-outlined !text-[18px]">tune</i>
      <span class="hidden sm:inline">Filtros</span>
      @if (hasActiveFilters()) {
        <span class="w-2 h-2 bg-[#E60012] rounded-full"></span>
      }
    </button>
  </div>

  <!-- Panel de filtros (cotizador) -->
  @if (showFilters()) {
    <div class="bg-white dark:bg-[#0c1427] rounded-xl border border-gray-200 dark:border-[#172036] p-4 mb-4 animate-fade-in">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-sm font-semibold text-gray-900 dark:text-white flex items-center gap-2">
          <i class="material-symbols-outlined !text-[18px] text-[#E60012]">filter_alt</i>
          Cotizador de llantas
        </h3>
        @if (hasActiveFilters()) {
          <button
            type="button"
            (click)="clearAllFilters()"
            class="text-xs text-[#E60012] hover:text-red-700 font-medium flex items-center gap-1"
          >
            <i class="material-symbols-outlined !text-[14px]">close</i>
            Limpiar filtros
          </button>
        }
      </div>

      <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3">
        <!-- Ancho -->
        <div>
          <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1.5">Ancho</label>
          <select
            class="w-full h-10 px-3 rounded-lg border border-gray-200 dark:border-[#172036] bg-white dark:bg-[#0a0f1a] text-sm text-gray-900 dark:text-white focus:border-[#E60012] outline-none"
            [value]="selectedAncho() ?? ''"
            (change)="onFilterChange('ancho', $any($event.target).value)"
          >
            <option value="">Todos</option>
            @for (ancho of anchos(); track ancho) {
              <option [value]="ancho">{{ ancho }}</option>
            }
          </select>
        </div>

        <!-- Perfil -->
        <div>
          <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1.5">Perfil</label>
          <select
            class="w-full h-10 px-3 rounded-lg border border-gray-200 dark:border-[#172036] bg-white dark:bg-[#0a0f1a] text-sm text-gray-900 dark:text-white focus:border-[#E60012] outline-none"
            [value]="selectedPerfil() ?? ''"
            (change)="onFilterChange('perfil', $any($event.target).value)"
          >
            <option value="">Todos</option>
            @for (perfil of perfiles(); track perfil) {
              <option [value]="perfil">{{ perfil }}</option>
            }
          </select>
        </div>

        <!-- Rin -->
        <div>
          <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1.5">Rin</label>
          <select
            class="w-full h-10 px-3 rounded-lg border border-gray-200 dark:border-[#172036] bg-white dark:bg-[#0a0f1a] text-sm text-gray-900 dark:text-white focus:border-[#E60012] outline-none"
            [value]="selectedRin() ?? ''"
            (change)="onFilterChange('rin', $any($event.target).value)"
          >
            <option value="">Todos</option>
            @for (rin of rines(); track rin) {
              <option [value]="rin">R{{ rin }}</option>
            }
          </select>
        </div>

        <!-- Construcción -->
        <div>
          <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1.5">Construcción</label>
          <select
            class="w-full h-10 px-3 rounded-lg border border-gray-200 dark:border-[#172036] bg-white dark:bg-[#0a0f1a] text-sm text-gray-900 dark:text-white focus:border-[#E60012] outline-none"
            [value]="selectedConstruccion() ?? ''"
            (change)="onFilterChange('construccion', $any($event.target).value)"
          >
            <option value="">Todas</option>
            @for (c of construcciones(); track c) {
              <option [value]="c">{{ c }}</option>
            }
          </select>
        </div>

        <!-- Uso -->
        <div>
          <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1.5">Uso</label>
          <select
            class="w-full h-10 px-3 rounded-lg border border-gray-200 dark:border-[#172036] bg-white dark:bg-[#0a0f1a] text-sm text-gray-900 dark:text-white focus:border-[#E60012] outline-none"
            [value]="selectedUso() ?? ''"
            (change)="onFilterChange('uso', $any($event.target).value)"
          >
            <option value="">Todos</option>
            @for (uso of usos(); track uso) {
              <option [value]="uso">{{ uso }}</option>
            }
          </select>
        </div>

        <!-- Índice de carga -->
        <div>
          <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1.5">Índice carga</label>
          <select
            class="w-full h-10 px-3 rounded-lg border border-gray-200 dark:border-[#172036] bg-white dark:bg-[#0a0f1a] text-sm text-gray-900 dark:text-white focus:border-[#E60012] outline-none"
            [value]="selectedIndiceCarga() ?? ''"
            (change)="onFilterChange('indiceCarga', $any($event.target).value)"
          >
            <option value="">Todos</option>
            @for (ic of indicesCarga(); track ic) {
              <option [value]="ic">{{ ic }}</option>
            }
          </select>
        </div>
      </div>

      <!-- Solo en stock -->
      <div class="mt-4 flex items-center gap-2">
        <input
          type="checkbox"
          id="onlyInStock"
          [checked]="onlyInStock()"
          (change)="onInStockToggle($any($event.target).checked)"
          class="w-4 h-4 rounded border-gray-300 text-[#E60012] focus:ring-[#E60012]"
        />
        <label for="onlyInStock" class="text-sm text-gray-600 dark:text-gray-400 cursor-pointer">
          Mostrar solo productos en existencia
        </label>
      </div>
    </div>
  }

  <!-- Contador de resultados -->
  <div class="flex items-center justify-between text-sm text-gray-600 dark:text-gray-400">
    <span>{{ items().length }} productos encontrados</span>
  </div>
</div>

<!-- Grid de productos -->
<div class="mb-6">
  @if (loading()) {
    <div class="grid sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
      @for (i of [1,2,3,4,5,6,7,8]; track i) {
        <div class="bg-white dark:bg-[#0c1427] rounded-xl p-4 animate-pulse">
          <div class="aspect-square bg-gray-200 dark:bg-[#15203c] rounded-lg mb-3"></div>
          <div class="h-4 bg-gray-200 dark:bg-[#15203c] rounded mb-2"></div>
          <div class="h-3 bg-gray-200 dark:bg-[#15203c] rounded w-2/3"></div>
        </div>
      }
    </div>
  } @else if (error()) {
    <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl p-6 text-center">
      <i class="material-symbols-outlined !text-[40px] text-red-400 mb-2">error</i>
      <p class="text-red-600 dark:text-red-400">{{ error() }}</p>
      <button
        type="button"
        (click)="clearAllFilters()"
        class="mt-3 text-sm text-red-600 hover:text-red-700 font-medium"
      >
        Reintentar
      </button>
    </div>
  } @else if (items().length === 0) {
    <div class="bg-white dark:bg-[#0c1427] rounded-xl p-12 text-center">
      <i class="material-symbols-outlined !text-[64px] text-gray-300 dark:text-gray-600 mb-4">search_off</i>
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">No se encontraron productos</h3>
      <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
        Intenta ajustar los filtros o buscar con otros términos.
      </p>
      @if (hasActiveFilters()) {
        <button
          type="button"
          (click)="clearAllFilters()"
          class="px-4 py-2 bg-[#E60012] hover:bg-red-700 text-white text-sm font-medium rounded-lg transition-colors"
        >
          Limpiar filtros
        </button>
      }
    </div>
  } @else {
    <div class="grid sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
      @for (item of items(); track item.tire.sku) {
        <div class="group bg-white dark:bg-[#0c1427] rounded-xl border border-gray-100 dark:border-[#172036] overflow-hidden hover:shadow-lg hover:border-[#E60012]/30 transition-all duration-300">
          <!-- Imagen del producto -->
          <div class="relative aspect-square bg-gray-50 dark:bg-[#0a0f1a] overflow-hidden">
            <img
              [src]="getTireImage(item)"
              [alt]="item.tire.medidaOriginal || item.tire.sku"
              class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
              loading="lazy"
            />
            <!-- Badge de precio -->
            <div class="absolute bottom-3 right-3 px-3 py-1.5 bg-[#E60012] text-white text-sm font-bold rounded-lg shadow-lg">
              ${{ formatPrice(item.price) }}
            </div>
            <!-- Badge de en carrito -->
            @if (isInCart(item.tire.sku)) {
              <div class="absolute top-3 right-3 w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center shadow-lg">
                <i class="material-symbols-outlined !text-[18px]">check</i>
              </div>
            }
          </div>

          <!-- Info del producto -->
          <div class="p-4">
            <h3 class="text-base font-semibold text-gray-900 dark:text-white mb-1 line-clamp-1">
              {{ formatMedida(item.tire) }}
            </h3>
            <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">
              SKU: {{ item.tire.sku }}
            </p>
            
            <div class="flex flex-wrap gap-1.5 mb-2">
              @if (item.tire.construccion) {
                <span class="px-2 py-0.5 bg-gray-100 dark:bg-[#15203c] text-gray-600 dark:text-gray-400 text-[10px] font-medium rounded">
                  {{ item.tire.construccion }}
                </span>
              }
              @if (item.tire.abreviaturaUso) {
                <span class="px-2 py-0.5 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 text-[10px] font-medium rounded">
                  {{ item.tire.abreviaturaUso }}
                </span>
              }
              @if (item.tire.indiceCarga) {
                <span class="px-2 py-0.5 bg-amber-50 dark:bg-amber-900/20 text-amber-600 dark:text-amber-400 text-[10px] font-medium rounded">
                  {{ item.tire.indiceCarga }}{{ item.tire.indiceVelocidad }}
                </span>
              }
            </div>

            <!-- Existencias -->
            <div class="flex items-center gap-1 mb-3">
              @if (item.stock !== null && item.stock !== undefined) {
                @if (item.stock > 10) {
                  <span class="flex items-center gap-1 text-xs text-green-600 dark:text-green-400">
                    <i class="material-symbols-outlined !text-[14px]">check_circle</i>
                    {{ item.stock }} en existencia
                  </span>
                } @else if (item.stock > 0) {
                  <span class="flex items-center gap-1 text-xs text-amber-600 dark:text-amber-400">
                    <i class="material-symbols-outlined !text-[14px]">warning</i>
                    Solo {{ item.stock }} disponibles
                  </span>
                } @else {
                  <span class="flex items-center gap-1 text-xs text-red-500">
                    <i class="material-symbols-outlined !text-[14px]">cancel</i>
                    Agotado
                  </span>
                }
              } @else {
                <span class="flex items-center gap-1 text-xs text-green-600 dark:text-green-400">
                  <i class="material-symbols-outlined !text-[14px]">check_circle</i>
                  Disponible
                </span>
              }
            </div>

            <!-- Controles de carrito -->
            @if (isInCart(item.tire.sku)) {
              <!-- Si ya está en el carrito, mostrar controles de cantidad -->
              <div class="flex items-center justify-between gap-2">
                <div class="flex items-center gap-1 flex-1">
                  <button 
                    type="button"
                    class="w-9 h-9 flex items-center justify-center rounded-lg bg-gray-100 dark:bg-[#15203c] text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-[#1e2d4d] transition-colors"
                    (click)="decrementCartItem(item.tire.sku)"
                  >
                    <i class="material-symbols-outlined !text-[18px]">remove</i>
                  </button>
                  <span class="flex-1 text-center text-sm font-semibold text-gray-900 dark:text-white">
                    {{ getCartQuantity(item.tire.sku) }}
                  </span>
                  <button 
                    type="button"
                    class="w-9 h-9 flex items-center justify-center rounded-lg bg-gray-100 dark:bg-[#15203c] text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-[#1e2d4d] transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    (click)="incrementCartItem(item.tire.sku)"
                    [disabled]="isAtMaxStock(item)"
                    [title]="isAtMaxStock(item) ? 'Cantidad máxima alcanzada' : 'Agregar uno más'"
                  >
                    <i class="material-symbols-outlined !text-[18px]">add</i>
                  </button>
                </div>
                <button 
                  type="button"
                  class="w-9 h-9 flex items-center justify-center rounded-lg text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors"
                  (click)="removeFromCart(item.tire.sku)"
                  title="Eliminar del carrito"
                >
                  <i class="material-symbols-outlined !text-[18px]">delete</i>
                </button>
              </div>
            } @else {
              <!-- Botón agregar al carrito -->
              <button
                type="button"
                (click)="addToCart(item)"
                class="w-full h-10 flex items-center justify-center gap-2 rounded-lg text-sm font-medium transition-all bg-gray-900 dark:bg-white hover:bg-gray-800 dark:hover:bg-gray-100 text-white dark:text-gray-900"
                [disabled]="item.stock === 0 || item.price === 0"
                [ngClass]="{'opacity-50 cursor-not-allowed': item.stock === 0 || item.price === 0}"
              >
                <i class="material-symbols-outlined !text-[18px]">add_shopping_cart</i>
                @if (item.stock === 0) {
                  Agotado
                } @else if (item.price === 0) {
                  Sin precio
                } @else {
                  Agregar al carrito
                }
              </button>
            }
          </div>
        </div>
      }
    </div>
  }
</div>

<!-- Toast de notificación -->
@if (showToast()) {
  <div class="fixed bottom-6 right-6 z-50 animate-slide-up">
    <div 
      class="flex items-center gap-3 px-4 py-3 rounded-xl shadow-2xl"
      [ngClass]="toastType() === 'success' 
        ? 'bg-green-500 text-white' 
        : 'bg-red-500 text-white'"
    >
      <i class="material-symbols-outlined !text-[20px]">
        {{ toastType() === 'success' ? 'check_circle' : 'error' }}
      </i>
      <span class="text-sm font-medium">{{ toastMessage() }}</span>
    </div>
  </div>
}
