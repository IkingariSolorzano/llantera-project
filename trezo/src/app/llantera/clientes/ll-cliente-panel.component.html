<div class="min-h-screen flex flex-col bg-gray-50 dark:bg-[#020617] text-gray-900 dark:text-gray-100">
  <!-- Header con carrito y menú de usuario -->
  <header class="sticky top-0 z-40 border-b border-gray-200 dark:border-[#172036] bg-white/95 dark:bg-[#020617]/95 backdrop-blur-sm">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
      <!-- Logo y título -->
      <div class="flex items-center gap-3">
        <a routerLink="/cliente" class="flex items-center gap-2">
          <img
            src="images/llantera/ico-llantera-hd.png"
            alt="Llantera de Occidente"
            class="h-10 w-auto"
            loading="lazy"
          />
        </a>
        <div class="hidden sm:flex flex-col">
          <span class="text-sm font-semibold text-gray-900 dark:text-gray-100">Llantera de Occidente</span>
          <span class="text-xs text-gray-500 dark:text-gray-400">Tienda en línea</span>
        </div>
      </div>

      <!-- Acciones del header -->
      <div class="flex items-center gap-1">
        <!-- Botón tema -->
        <button
          type="button"
          class="w-9 h-9 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-[#15203c] transition-all"
          (click)="toggleTheme()"
          aria-label="Cambiar tema"
        >
          <i class="material-symbols-outlined !text-[20px] text-[#fe7a36]">light_mode</i>
        </button>

        <!-- Notificaciones -->
        <app-ll-notification-bell />

        <!-- Carrito con badge y preview (hover) -->
        <div 
          class="relative"
          (mouseenter)="onCartMouseEnter()"
          (mouseleave)="onCartMouseLeave()"
        >
          <button
            type="button"
            class="w-9 h-9 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-[#15203c] transition-all relative"
            (click)="goToCart()"
            aria-label="Ver carrito"
          >
            <i class="material-symbols-outlined !text-[20px] text-gray-600 dark:text-gray-300">shopping_cart</i>
            @if (cart.itemCount() > 0) {
              <span class="absolute -top-0.5 -right-0.5 min-w-[18px] h-[18px] flex items-center justify-center bg-[#E60012] text-white text-[10px] font-bold rounded-full px-1">
                {{ cart.itemCount() > 99 ? '99+' : cart.itemCount() }}
              </span>
            }
          </button>

          <!-- Preview del carrito (aparece con hover) -->
          @if (showCartPreview()) {
            <div 
              class="absolute right-0 top-full mt-2 w-80 sm:w-96 bg-white dark:bg-[#0c1427] rounded-xl shadow-2xl border border-gray-200 dark:border-[#172036] overflow-hidden z-50"
              (mouseenter)="onCartMouseEnter()"
              (mouseleave)="onCartMouseLeave()"
            >
              <div class="px-4 py-3 border-b border-gray-200 dark:border-[#172036] flex items-center justify-between">
                <span class="font-semibold text-sm text-gray-900 dark:text-white">Tu carrito</span>
                <span class="text-xs text-gray-500">{{ cart.itemCount() }} productos</span>
              </div>
              
              <div class="max-h-72 overflow-y-auto">
                @if (cart.isEmpty()) {
                  <div class="px-4 py-8 text-center text-sm text-gray-500">
                    <i class="material-symbols-outlined !text-[40px] mb-2 opacity-40">shopping_cart</i>
                    <p>Tu carrito está vacío</p>
                    <p class="text-xs mt-1">Explora nuestro catálogo</p>
                  </div>
                } @else {
                  @for (cartItem of cart.items(); track cartItem.item.tire.sku) {
                    <div class="px-4 py-3 border-b border-gray-100 dark:border-[#172036] last:border-0">
                      <div class="flex items-start gap-3">
                        <img 
                          [src]="cartItem.item.tire.urlImagen || 'images/llantera/generic-tyre.png'" 
                          [alt]="cartItem.item.tire.medidaOriginal"
                          class="w-12 h-12 object-cover rounded-md bg-gray-100 dark:bg-[#15203c]"
                        />
                        <div class="flex-1 min-w-0">
                          <p class="text-sm text-gray-900 dark:text-white font-medium truncate">
                            {{ cartItem.item.tire.medidaOriginal || cartItem.item.tire.sku }}
                          </p>
                          <p class="text-xs text-gray-500 mb-1">SKU: {{ cartItem.item.tire.sku }}</p>
                          <div class="flex items-center justify-between">
                            <span class="text-sm font-semibold text-[#E60012]">${{ formatPrice(cartItem.item.price) }}</span>
                            <!-- Controles de cantidad -->
                            <div class="flex items-center gap-1">
                              <button 
                                type="button"
                                class="w-6 h-6 flex items-center justify-center rounded bg-gray-100 dark:bg-[#15203c] text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-[#1e2d4d] transition-colors"
                                (click)="decrementCartItem(cartItem.item.tire.sku); $event.stopPropagation()"
                              >
                                <i class="material-symbols-outlined !text-[14px]">remove</i>
                              </button>
                              <span class="w-8 text-center text-sm font-medium text-gray-900 dark:text-white">{{ cartItem.quantity }}</span>
                              <button 
                                type="button"
                                class="w-6 h-6 flex items-center justify-center rounded bg-gray-100 dark:bg-[#15203c] text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-[#1e2d4d] transition-colors"
                                (click)="incrementCartItem(cartItem.item.tire.sku); $event.stopPropagation()"
                              >
                                <i class="material-symbols-outlined !text-[14px]">add</i>
                              </button>
                              <button 
                                type="button"
                                class="w-6 h-6 flex items-center justify-center rounded text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors ml-1"
                                (click)="removeFromCart(cartItem.item.tire.sku); $event.stopPropagation()"
                                title="Eliminar del carrito"
                              >
                                <i class="material-symbols-outlined !text-[14px]">delete</i>
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  }
                }
              </div>

              @if (!cart.isEmpty()) {
                <div class="px-4 py-3 border-t border-gray-200 dark:border-[#172036] bg-gray-50 dark:bg-[#0a0f1a]">
                  <div class="flex items-center justify-between mb-3">
                    <span class="text-sm text-gray-600 dark:text-gray-400">Subtotal:</span>
                    <span class="text-lg font-bold text-gray-900 dark:text-white">${{ formatPrice(cart.subtotal()) }}</span>
                  </div>
                  <button
                    type="button"
                    class="w-full py-2.5 bg-[#E60012] hover:bg-red-700 text-white text-sm font-semibold rounded-lg transition-colors flex items-center justify-center gap-2"
                    (click)="goToCart()"
                  >
                    <i class="material-symbols-outlined !text-[18px]">shopping_cart</i>
                    Ir a mi carrito
                  </button>
                </div>
              }
            </div>
          }
        </div>

        <!-- Menú de usuario -->
        <div class="relative ml-1">
          <button
            type="button"
            class="flex items-center gap-2 px-2 py-1.5 rounded-full hover:bg-gray-100 dark:hover:bg-[#15203c] transition-all"
            (click)="toggleUserMenu()"
          >
            <div class="w-8 h-8 rounded-full bg-gradient-to-br from-[#E60012] to-[#ff4d5a] flex items-center justify-center text-white font-semibold text-sm shadow-md">
              {{ userInitials() }}
            </div>
            <i class="material-symbols-outlined !text-[18px] text-gray-500 hidden sm:block">expand_more</i>
          </button>

          @if (showUserMenu()) {
            <div class="absolute right-0 top-full mt-2 w-56 bg-white dark:bg-[#0c1427] rounded-xl shadow-2xl border border-gray-200 dark:border-[#172036] overflow-hidden z-50">
              <div class="px-4 py-3 border-b border-gray-200 dark:border-[#172036]">
                <p class="text-sm font-semibold text-gray-900 dark:text-white truncate">{{ userName() }}</p>
                <p class="text-xs text-gray-500 truncate">{{ userEmail() }}</p>
              </div>
              <div class="py-1">
                <button type="button"
                  class="w-full px-4 py-2.5 text-left text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-[#15203c] flex items-center gap-3 transition-colors"
                  (click)="setTab('cuenta')">
                  <i class="material-symbols-outlined !text-[18px] text-gray-500">person</i>
                  Mi cuenta
                </button>
                <button type="button"
                  class="w-full px-4 py-2.5 text-left text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-[#15203c] flex items-center gap-3 transition-colors"
                  (click)="setTab('direcciones')">
                  <i class="material-symbols-outlined !text-[18px] text-gray-500">location_on</i>
                  Mis direcciones
                </button>
                <button type="button"
                  class="w-full px-4 py-2.5 text-left text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-[#15203c] flex items-center gap-3 transition-colors"
                  (click)="setTab('pedidos')">
                  <i class="material-symbols-outlined !text-[18px] text-gray-500">local_shipping</i>
                  Mis pedidos
                </button>
              </div>
              <div class="border-t border-gray-200 dark:border-[#172036] py-1">
                <button type="button"
                  class="w-full px-4 py-2.5 text-left text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 flex items-center gap-3 transition-colors"
                  (click)="logout()">
                  <i class="material-symbols-outlined !text-[18px]">logout</i>
                  Cerrar sesión
                </button>
              </div>
            </div>
          }
        </div>
      </div>
    </div>
  </header>

  <!-- Navegación por tabs -->
  <nav class="bg-white dark:bg-[#0c1427] border-b border-gray-200 dark:border-[#172036] sticky top-[65px] z-30">
    <div class="max-w-7xl mx-auto px-4">
      <div class="flex gap-1 overflow-x-auto py-2 scrollbar-hide">
        <button
          type="button"
          (click)="setTab('catalogo')"
          class="px-4 py-2 rounded-lg font-medium text-sm whitespace-nowrap transition-all"
          [ngClass]="activeTab() === 'catalogo'
            ? 'bg-[#E60012] text-white shadow-sm'
            : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-[#15203c]'"
        >
          <i class="material-symbols-outlined !text-[18px] align-middle mr-1">storefront</i>
          Catálogo
        </button>

        <button
          type="button"
          (click)="setTab('carrito')"
          class="px-4 py-2 rounded-lg font-medium text-sm whitespace-nowrap transition-all relative"
          [ngClass]="activeTab() === 'carrito'
            ? 'bg-[#E60012] text-white shadow-sm'
            : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-[#15203c]'"
        >
          <i class="material-symbols-outlined !text-[18px] align-middle mr-1">shopping_cart</i>
          Carrito
          @if (cart.itemCount() > 0) {
            <span class="ml-1 px-1.5 py-0.5 text-[10px] font-bold rounded-full"
              [ngClass]="activeTab() === 'carrito' ? 'bg-white text-[#E60012]' : 'bg-[#E60012] text-white'">
              {{ cart.itemCount() }}
            </span>
          }
        </button>

        <button
          type="button"
          (click)="setTab('pedidos')"
          class="px-4 py-2 rounded-lg font-medium text-sm whitespace-nowrap transition-all"
          [ngClass]="activeTab() === 'pedidos'
            ? 'bg-[#E60012] text-white shadow-sm'
            : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-[#15203c]'"
        >
          <i class="material-symbols-outlined !text-[18px] align-middle mr-1">local_shipping</i>
          Pedidos
        </button>

        <button
          type="button"
          (click)="setTab('compras')"
          class="px-4 py-2 rounded-lg font-medium text-sm whitespace-nowrap transition-all"
          [ngClass]="activeTab() === 'compras'
            ? 'bg-[#E60012] text-white shadow-sm'
            : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-[#15203c]'"
        >
          <i class="material-symbols-outlined !text-[18px] align-middle mr-1">receipt_long</i>
          Compras
        </button>

        <button
          type="button"
          (click)="setTab('cuenta')"
          class="px-4 py-2 rounded-lg font-medium text-sm whitespace-nowrap transition-all"
          [ngClass]="activeTab() === 'cuenta'
            ? 'bg-[#E60012] text-white shadow-sm'
            : 'text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-[#15203c]'"
        >
          <i class="material-symbols-outlined !text-[18px] align-middle mr-1">person</i>
          Mi cuenta
        </button>
      </div>
    </div>
  </nav>

  <!-- Contenido principal -->
  <main class="flex-1">
    <div class="max-w-7xl mx-auto px-4 py-5 md:py-6">
      @switch (activeTab()) {
        @case ('catalogo') {
          <app-ll-clientes-catalog-page></app-ll-clientes-catalog-page>
        }
        @case ('carrito') {
          <app-ll-cliente-carrito></app-ll-cliente-carrito>
        }
        @case ('pedidos') {
          <app-ll-cliente-pedidos></app-ll-cliente-pedidos>
        }
        @case ('compras') {
          <app-ll-cliente-compras></app-ll-cliente-compras>
        }
        @case ('cuenta') {
          <app-ll-cliente-cuenta></app-ll-cliente-cuenta>
        }
        @case ('direcciones') {
          <app-ll-cliente-direcciones></app-ll-cliente-direcciones>
        }
      }
    </div>
  </main>

  <!-- Footer -->
  <footer class="border-t border-gray-200 dark:border-[#172036] bg-white dark:bg-[#0c1427] py-4">
    <div class="max-w-7xl mx-auto px-4 text-center text-xs text-gray-500">
      © {{ 2024 }} Llantera de Occidente. Todos los derechos reservados.
    </div>
  </footer>
</div>

<!-- Overlay para cerrar dropdowns -->
@if (showCartPreview() || showUserMenu()) {
  <div class="fixed inset-0 z-30" (click)="closeAllDropdowns()"></div>
}
